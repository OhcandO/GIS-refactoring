<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title> vworld (AS-IS) 와 eMap (TO-BE) 비교 실험 </title>
    <!-- JQuery -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    
    <!-- openlayers 6.15.0 -->
    <script type="text/javascript" src="./ol6/proj4-src.js"></script>
    <link type="text/css" rel="stylesheet" href="./v6.15.0-dist/ol.css">
    <script type="text/javascript" src="./v6.15.0-dist/ol.js"></script>

    <!-- emap api -->
    <script type="text/javascript" src="http://map.ngii.go.kr/openapi/wmts_ngiiMap_v6.4.3.js?apikey=F2AB591859D900772643FD3523B1761D"></script>
    <script>
      let emapMap;
      let layerObj;

      const emapView = new ol.View({projection:'EPSG:5179'});
      const vworldView = new ol.View();

      window.onload = function () {

        const mapBounds = [705680.0, 1349270.0, 1388291.0, 2581448.0];

        emapMap = new ol.Map({
          target: document.getElementById("map"),
          view: emapView,
          interactions: ol.interaction.defaults({ mouseWheelZoom: false }).extend([
            new ol.interaction.MouseWheelZoom({
              constrainResolution: true
            })
          ]),  
        });

        const PROPERTIES = {	
            tileNames_en : ["korean_map","color_map","lowV_map","english_map","white_map"
            // ,"chinese_map","japanese_map","white_edu_map"
            ,"base_hd","AIRPHOTO","night_map"	],
            tileNames_ko : [    "일반", "색각",  "큰글씨", "영문",  "백지도"
            // , "중문",  "일문",   "교육용백지도"
            ,    "일반HD",   "영상지도",    "야간지도"],
        };
        

        //국토정보맵 WMTS
        function getWMTSsource(layerId_en) {
          return {
            url: "//map.ngii.go.kr/openapi/Gettile.do?apikey=" + ngii_wmts.apikey,
            matrixSet: "EPSG:5179"
            , format: "image/png"
            , projection: ol.proj.get('EPSG:5179')
            , tileGrid: new ol.tilegrid.WMTS({
              origin: ol.extent.getTopLeft(epsg_5179.getExtent()),
              resolutions: [2088.96, 1044.48, 522.24, 261.12, 130.56, 65.28, 32.64, 16.32, 8.16, 4.08, 2.04, 1.02, 0.51, 0.255],
              matrixIds: ["L05", "L06", "L07", "L08", "L09", "L10", "L11", "L12", "L13", "L14", "L15", "L16", "L17", "L18"]
            })
            , style: 'korean'
            , crossOrigin: 'anonymous'
            , name: layerId_en
            , layer: layerId_en
          }
        }
        

        //국토정보맵 항공사진 WMTS
        function getWMTSsourceAIR(layerId_en) {
          return {
            url: "http://210.117.198.120:8081/o2map/services?apikey="+ngii_wmts.apikey
            ,matrixSet : "NGIS_AIR"
            ,format: "image/jpg"
            , projection: ol.proj.get('EPSG:5179')
            , tileGrid: new ol.tilegrid.WMTS({
              origin : ol.extent.getTopLeft(epsg_5179.getExtent()),
              resolutions : [2088.96, 1044.48, 522.24, 261.12, 130.56, 65.28, 32.64, 16.32, 8.16, 4.08, 2.04, 1.02, 0.51, 0.255],
              matrixIds : ["5","6","7","8","9","10","11","12","13","14","15","16","17","18"]
            })
            ,style : '_null'
            ,wrapX : true
            ,crossOrigin: 'anonymous'
            ,tileLoadFunction: function(imageTile, src) {
              imageTile.getImage().src = "http://map.ngii.go.kr/openapi/proxy/proxyTile.jsp?apikey="+ngii_wmts.apikey+ "&URL=" + encodeURIComponent(src);
            }
            , name: layerId_en
            , layer: layerId_en
          }
        }

        //국토정보맵 XYZ 형태로 가져오기
        function wmtEmapOption2(layerId, boolVisible) {
          console.log('override')
          return {
            url: "//map.ngii.go.kr/openapi/Gettile.do?apikey=" + ngii_wmts.apikey
            , matrixSet: "EPSG:5179"
            , format: "image/png"
            , projection: epsg_5179
            , tileGrid: new ol.tilegrid.WMTS({
              origin: ol.extent.getTopLeft(epsg_5179.getExtent()),
              resolutions: [2088.96, 1044.48, 522.24, 261.12, 130.56, 65.28, 32.64, 16.32, 8.16, 4.08, 2.04, 1.02, 0.51, 0.255],
              matrixIds: ["L05", "L06", "L07", "L08", "L09", "L10", "L11", "L12", "L13", "L14", "L15", "L16", "L17", "L18"]
            })
            , style: 'korean'
            , wrapX: true
            , crossOrigin: 'anonymous'
            , visible: boolVisible
            , source: new ol.source.XYZ({ 
              tileUrlFunction: function (coordinate) {
                coordinate[0] = "L" + ngii_wmts.util.fillzero(coordinate[0] + 5, 2);
                url = "//map.ngii.go.kr/openapi/Gettile.do?apikey=" + ngii_wmts.apikey + "&service=" + "WMTS" + "&request=" + "GetTile"
                  + "&version=" + "1.0.0" + "&layer=" + layerId + "&style=korean"
                  + "&format=image/png" + "&tilematrixset=korean"
                  + "&tilematrix=" + coordinate[0] + "&tilerow=" + coordinate[2]
                  + "&tilecol=" + coordinate[1];
                return url;
              },
              type: 'image/png',
              tileSize: new ol.size.toSize([256, 256]),
              maxResolution: 2088.96,
              maxZoom:13,
              projection: "EPSG:5179",
              // transition:250,
              // interpolate:true,
            })
          }
        }

        // 지도 발행 및 초기화 (기본 지도만 visible=true)
        layerObj ={};
        for (let idx = 0; idx < PROPERTIES.tileNames_en.length; idx++) {
          const id = PROPERTIES.tileNames_en[idx];
          const id_ko = PROPERTIES.tileNames_ko[idx];
          if(id=='korean_map'){
            // layerObj[id_ko] = new ol.layer.Tile(wmtEmapOption2('korean_map', true));
            layerObj[id_ko] = new ol.layer.Tile({
              source: new ol.source.WMTS( getWMTSsource('korean_map') )
              ,visible:true
            });
          }else if(id=='AIRPHOTO'){
            layerObj[id_ko] = new ol.layer.Tile({
              source: new ol.source.WMTS( getWMTSsourceAIR(id) )
              ,visible:false
            });
          }
          else{
            // layerObj[id_ko] = new ol.layer.Tile(wmtEmapOption2(id,false));
            layerObj[id_ko] = new ol.layer.Tile({
              source: new ol.source.WMTS( getWMTSsource(id) )
              ,visible:false
            });
          }
          emapMap.addLayer(layerObj[id_ko]);
        }

        //버튼 이벤트 생성 
        if(Object.keys(layerObj).length>0){
          let target = document.querySelector('#shiftMapBtn');
          let tempContainer = document.createElement('div');
          let tempBtn = document.querySelector('#temp_btn').content.cloneNode(true); //a tag documentFragment
          Object.entries(layerObj).forEach(([id,layer])=>{
            // layer=>map.addLayer(layer);
            let btn = tempBtn.cloneNode(true);
            //console.log(id,layer);
            // btn.querySelector('a').onclick = function(){ngii_wmts.setBaselayer(emapMap,layerObj[id])};
           
            btn.querySelector('a').innerText = id;
            tempContainer.appendChild(btn);
          });
          // target.appendChild(tempContainer);
          target.insertAdjacentElement('beforeend',tempContainer);

          function basing(layer){
            console.log(layer);
            ngii_wmts.setBaseLayer(emapMap,layer)
          }
          document.querySelectorAll('#shiftMapBtn a').forEach(el=>{
            let id = el.innerText;
            el.addEventListener('click',function(){ basing(layerObj[id]) } );
          });
        }
        
        //지도 초기위치 결정
        // emapMap.getView().fit(mapBounds);
        const ANSUNG_CITYHALL = [980421.8025, 1889949.3858];
        emapMap.getView().setCenter(ANSUNG_CITYHALL);
        emapMap.getView().setZoom(16);

      };

    </script>
    <script>
      let vworldMap, vworldLayer, vworldLayerAIR;

      document.addEventListener('DOMContentLoaded', function () {

        vworldLayer = new ol.layer.Tile({
          id: 'vworld',
          visible: true,
          source: new ol.source.XYZ({
            url: "http://xdworld.vworld.kr:8080/2d/Base/service/{z}/{x}/{y}.png",
            maxZoom: 19,
            crossOrigin: "anonymous",
          })
        });

        vworldLayerAIR = new ol.layer.Tile({
          id: 'vworldAIR',
          visible: false,
          source: new ol.source.XYZ({
            url: "http://xdworld.vworld.kr:8080/2d/Satellite/service/{z}/{x}/{y}.jpeg",
            maxZoom: 19,
            crossOrigin: "anonymous",
          })
        });

        vworldMap = new ol.Map({
          target: document.querySelector('#vworldMap'),
          view: vworldView,
          interactions: ol.interaction.defaults({ mouseWheelZoom: false }).extend([
            new ol.interaction.MouseWheelZoom({
              constrainResolution: true
            })
          ]),
        });

        const PROPERTIES = {	
            tileNames_en : ["korean_map","color_map","lowV_map","english_map"
            // ,"white_map","chinese_map","japanese_map","white_edu_map"
            ,"base_hd","AIRPHOTO","night_map"	],
            tileNames_ko : [    "일반", "색각",  "큰글씨", "영문"
            // ,  "백지도", "중문",  "일문",   "교육용백지도"
            ,    "일반HD",   "영상지도",    "야간지도"],
        };

        let layerObj = {
          일반_vworld:vworldLayer,
          항공_vworld:vworldLayerAIR
        };

        //버튼 이벤트 생성 
        if (Object.keys(layerObj).length > 0) {
          let target = document.querySelector('#shiftVworldBtn');
          let tempContainer = document.createElement('div');
          let tempBtn = document.querySelector('#temp_btn').content.cloneNode(true); //a tag documentFragment
          Object.entries(layerObj).forEach(([id, layer]) => {
            // layer=>map.addLayer(layer);
            let btn = tempBtn.cloneNode(true);
            //console.log(id,layer);
            // btn.querySelector('a').onclick = function(){ngii_wmts.setBaselayer(emapMap,layerObj[id])};

            btn.querySelector('a').innerText = id;
            tempContainer.appendChild(btn);
          });
          // target.appendChild(tempContainer);
          target.insertAdjacentElement('beforeend', tempContainer);

          function basing(_layer) {
            vworldMap.getLayers().getArray().forEach(layer=> {
              if(layer.get('id') == _layer.get('id')) {
                layer.setVisible(true);
              }else{layer.setVisible(false);}
            });
          }
          document.querySelectorAll('#shiftVworldBtn a').forEach(el => {
            let id = el.innerText;
            el.addEventListener('click', function () { basing(layerObj[id]) });
          });
        }

        vworldMap.addLayer(vworldLayer);
        vworldMap.addLayer(vworldLayerAIR);
        // const ANSUNG_CITYHALL = [980421.8025, 1889949.3858];
        const ANSUNG_CITYHALL =  [14168735.113711998, 4440166.65096346];
        // vworldMap.getView().setCenter(ol.proj.transform(ANSUNG_CITYHALL,'EPGS:5179','EPGS:3857'));
        vworldMap.getView().setCenter(ANSUNG_CITYHALL);
        vworldMap.getView().setZoom(16);

      });

    </script>
  </head>
  <body>
    <template id="temp_btn">
      <a href="javascript:;" ></a>
    </template>
    <div style="display: flex;  justify-content: space-evenly;">
      <div>
        <div id="shiftVworldBtn" style="height: 30px;"></div>
        <div id="vworldMap" style="width: 45vw; height: 90vh; "></div>
        <div style="height: 30px;">
          <a href="#" onclick="emapMap.setView(vworldView)">이걸(vworld) 기준삼기</a>
          <a href="#" onclick="vworldMap.setView(vworldView)">VIEW 복구</a>
        </div>
      </div>
      <div>
        <div id="shiftMapBtn" style="height: 30px;"></div>
        <div id="map" style="width: 45vw; height: 90vh; "></div>
        <div style="height: 30px;">
           
          <a href="#" onclick="vworldMap.setView(emapView)">이걸(emap) 기준삼기</a>
          <a href="#" onclick="emapMap.setView(emapView)">VIEW 복구</a> 
        </div>
      </div>
    </div>
  </body>
  
  </html>