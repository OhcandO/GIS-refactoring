<!-- WMTS 바로 요청 -->

<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>브이월드 오픈API</title>
    <title>2DMap</title>
    <link rel="stylesheet" href="./lib/openlayers_v7.5.1/ol.css">
    <link rel="stylesheet" href="./lib/spin.js/spin.css">
    <link rel="stylesheet" href="./lib/jstree-3.3.16/style.min.css">
    <style>
        .wrapper{position: relative;}
        #map {position: relative;height: 600px;border: 1px solid brown;}
        #progress {position: absolute;bottom: 0;left: 0;height: 0;
            box-shadow: 0px 0px 1px 2px rgb(255,204,0);
            width: 0;transition: width 250ms;}
        #baseLayerShifter{position: absolute;top: 15px;right: 15px;
            flex-direction: row-reverse;justify-content: space-between;}
        #baseLayerShifter_option{display: none;padding-right: 13px;}
        button#baseLayerShifter_btn {height: 34px;}
        .layerChanger {background-color: antiquewhite;
            border: 1px solid black;width: 90px;margin-right: 6px;}
        .mogis.flex{display: flex;}
        .mogis.flex.options {flex-direction: row;height: 65px;}

        .mogis.layerTree_wrapper{
            position:absolute;
            top:150px;
            left:150px;
        }
    </style>

    <script type="module" src="./main.js"></script>
    <script type="module">
    import { Spinner } from '../lib/spin.js/spin.js';
    import {TileLoadProgress} from './MO_GIS/classes/addon/TileLoadProgress.js';
    import {Measure} from './MO_GIS/classes/addon/measure.js';
    import mainMap from './main.js'

    const default_spinner = {
        lines: 15, length: 38, width: 12, radius: 38, scale: 1, corners: 1, speed: 1, rotate: 0,
        animation: "spinner-line-fade-more", direction: "1", color: "#ffffff",
        fadeColor: "transparent", top: "50%", left: "50%", shadow: "grey 3px 4px 8px 1px",
        zIndex: 2000000000, className: "spinner", position: "absolute",};
    let tileLoadProgress = new TileLoadProgress(document.querySelector(`#progress`));
    //----SPINNER
    let spin = new Spinner(default_spinner);
    mainMap.map.on("loadstart",()=>{showMapLoading(); tileLoadProgress.show();})
    mainMap.map.on("loadend",()=>{hideMapLoading(); tileLoadProgress.hide();})


    mainMap.map.getLayers().getArray().filter(layer=>layer.get(`isBase`))
    .forEach(baseLayer=>{
        baseLayer.getSource().on(`tileloadstart`,function(){tileLoadProgress.addLoading()})
        baseLayer.getSource().on(`tileloadend`,function(){tileLoadProgress.addLoaded()})
    })



    //지도 위 이벤트들
        //배경지도 선택기 노출 버튼
    document.querySelector(`#baseLayerShifter_btn`).addEventListener(`click`,function(e){
        let options = document.querySelector(`#baseLayerShifter_option`);
        if(options.style.display ==='') options.style.display='block';
        else options.style.display ='';
    });
    //배경지도 선택기
    document.querySelectorAll(`.layerChanger`)
    .forEach(node => {
        const baseLayers= ['Base','midnight','gray','Satellite'];
        const hybridLayer= 'Hybrid';

            node.addEventListener(`click`, function (e) {
                let layerName = node.dataset[`layer`];
                //하이브리드 레이어 켜고 끄기
                if(layerName===hybridLayer) {
                    let hyb = mainMap.map.getLayers().getArray().find(layer=>layer.get('typeName')==hybridLayer);
                    if(hyb) hyb.getVisible()? hyb.setVisible(false): hyb.setVisible(true);
                }else{
                    //다른 레이어들은 바꾸기
                    mainMap.map.getLayers().getArray().filter(layer=>baseLayers.includes(layer.get('typeName')))
                    .forEach(layer => {
                        if (baseLayers.includes(layerName) && layer.get('typeName') === layerName) {
                            layer.setVisible(true);
                        } else layer.setVisible(false);
                    })
                }
            });
    });

    //측정도구
    let measure = new Measure(mainMap.map, false);

    document.querySelectorAll(`input[name="control_measure"]`).forEach(node=>{
        node.addEventListener('change',function(e){
            if(e.target.checked){
                measure.activeMeasure(e.target.value);
            }
        })
    })

    function showMapLoading(){spin.spin(document.querySelector(`#map`));}
    function hideMapLoading(){spin.stop();}

    globalThis.mainMap_prepare = showMapLoading;
    globalThis.mainMap_done= hideMapLoading;
    </script>
   
</head>

<body>
<!-- 지도 그 자체 -->    
    <div class="wrapper">

        <div id="map"></div>
        <div id="progress"></div>
    </div>

<!-- 지도 좌측 레이어제어 버튼뭉치 -->
    <div>
        <div class="mogis layerTree_wrapper">
            <button type="button">GIS관망도</button>
            <div id="core-LayerTree"></div>
        </div>
    </div>
<!-- 지도 우측 툴바 -->
    <div>
        <!-- 레이어 변경 -->
        <div class="mogis control flex container" id="baseLayerShifter">
            <button id="baseLayerShifter_btn" type="button" data-toggle="false">레이어 선택</button>
            <div id="baseLayerShifter_option">
                <div class="mogis flex options">
                    <div class="layerChanger" data-layer="Base">기본</div>
                    <div class="layerChanger" data-layer="Satellite">위성</div>
                    <div class="layerChanger" data-layer="midnight">야간</div>
                    <div class="layerChanger" data-layer="gray">백지도</div>
                    <div class="layerChanger" data-layer="Hybrid">하이브리드</div>
                </div>
            </div>
        </div>

        <!-- 길이, 면적 측정도구 (라디오버튼으로 구성할 것) -->
        <div class="mogis control flex container" id="measure">
            <div class="mogis measure option">
                <label for="pan">
                    <input type="radio" name="control_measure" id="pan" value="">기본
                </label>
            </div>
            <div class="mogis measure option">
                <label for="measure_line">
                    <input type="radio" name="control_measure" id="measure_line" value="LineString">길이
                </label>
            </div>
            <div class="mogis measure option">
                <label for="poly">
                    <input type="radio" name="control_measure" id="poly" value="Polygon">면적
                </label>
            </div>
        </div>

    </div>
</body>

</html>