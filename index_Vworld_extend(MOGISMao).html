<!-- WMTS 바로 요청 -->

<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>브이월드 오픈API</title>
    <title>2DMap</title>
    <link rel="stylesheet" href="./lib/openlayers_v7.5.1/ol.css">
    <link rel="stylesheet" href="./lib/spin.js/spin.css">
    <style>
        .wrapper{
            position: relative;
        }
        #map {
            position: relative;
            height: 600px;
            border: 1px solid brown;
        }
        #progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 0;
            box-shadow: 0px 0px 1px 2px rgb(255,204,0);
            width: 0;
            transition: width 250ms;
      }
        #baseLayerShifter{
            position: absolute;
            top: 15px;
            right: 15px;
            flex-direction: row-reverse;
            justify-content: space-between;
        }
        #baseLayerShifter_option{
            display: none;
            padding-right: 13px;
        }
        button#baseLayerShifter_btn {
          height: 34px;
        }
        .layerChanger {
            background-color: antiquewhite;
            border: 1px solid black;
            width: 90px;
            margin-right: 6px;
        }
        .mogis.flex{
            display: flex;
        }
        .mogis.flex.options {
            flex-direction: row;
            height: 65px;
        }
    </style>

    <script type="module">

    import { SourceFactory } from "./MO_GIS/classes/MO.SourceFactory.js";
    import { LayerFactory } from "./MO_GIS/classes/MO.LayerFactory.js";
    import { StyleFactory } from "./MO_GIS/classes/MO.StyleFactory.js";
    import {MOGISMap} from './MO_GIS/classes/MO.MOGISMap.js';
    import { Spinner } from '../lib/spin.js/spin.js';
    import {TileLoadProgress} from './MO_GIS/classes/addon/TileLoadProgress.js';

    import {Measure} from './MO_GIS/classes/addon/measure.js';
        //DB에서 관리
        const baseLayerCode = 
        [
            {
                sourceType: "wmts", category: "vworld", srid: "EPSG:3857", origin: "https://api.vworld.kr",
                sourcePathname: "/req/wmts/1.0.0/{key}/{layer}/{tileMatrix}/{tileRow}/{tileCol}.{tileType}",
                id: 1, layerTitle: "vworld_base", typeName: "Base", boolIsdefault: "Y",
                apiKey: "B58E48FE-683E-3E7E-B91C-2F912512FE60",  layerType: "BASE", 
            },
            {
                sourceType: "wmts", category: "vworld", srid: "EPSG:3857", origin: "https://api.vworld.kr",
                sourcePathname: "/req/wmts/1.0.0/{key}/{layer}/{tileMatrix}/{tileRow}/{tileCol}.{tileType}",
                id: 2, layerTitle: "vworld_Satellite", typeName: "Satellite", boolIsdefault: "N",
                apiKey: "B58E48FE-683E-3E7E-B91C-2F912512FE60", layerType: "BASE", 
            },
            {
                sourceType: "wmts", category: "vworld", srid: "EPSG:3857", origin: "https://api.vworld.kr",
                sourcePathname: "/req/wmts/1.0.0/{key}/{layer}/{tileMatrix}/{tileRow}/{tileCol}.{tileType}",
                id: 3, layerTitle: "vworld_gray", typeName: "gray", boolIsdefault: "N",
                apiKey: "B58E48FE-683E-3E7E-B91C-2F912512FE60", layerType: "BASE", 
            },
            {
                sourceType: "wmts", category: "vworld", srid: "EPSG:3857", origin: "https://api.vworld.kr",
                sourcePathname: "/req/wmts/1.0.0/{key}/{layer}/{tileMatrix}/{tileRow}/{tileCol}.{tileType}",
                id: 4, layerTitle: "vworld_midnight", typeName: "midnight", boolIsdefault: "N",
                apiKey: "B58E48FE-683E-3E7E-B91C-2F912512FE60", layerType: "BASE", 
            },
            {
                sourceType: "wmts", category: "vworld", srid: "EPSG:3857", origin: "https://api.vworld.kr",
                sourcePathname: "/req/wmts/1.0.0/{key}/{layer}/{tileMatrix}/{tileRow}/{tileCol}.{tileType}",
                id: 5, layerTitle: "vworld_Hybrid", typeName: "Hybrid", boolIsdefault: "N",
                apiKey: "B58E48FE-683E-3E7E-B91C-2F912512FE60", layerType: "BASE", zIndex:10,
            }
        ]
        ;

        const default_spec = {
            /** Map 이 생성될 기본 DIV id */
            target: 'map',
            projection: `EPSG:3857`,
            center: [14184534.901084, 4433272.596271],  
            zoom:11
        };

        const default_spinner = {
            lines: 15, length: 38, width: 12, radius: 38,
            scale: 1, corners: 1, speed: 1, rotate: 0,
            animation: "spinner-line-fade-more",
            direction: "1", color: "#ffffff",
            fadeColor: "transparent",
            top: "50%", left: "50%", shadow: "grey 3px 4px 8px 1px",
            zIndex: 2000000000,
            className: "spinner", position: "absolute",
        };

        let mainMap = new MOGISMap(default_spec);
        mainMap.setFactory(new SourceFactory());
        mainMap.setFactory(new LayerFactory());
        mainMap.setFactory(new StyleFactory());

        mainMap.setBaseLayerCodeArr(baseLayerCode);
        
        let tileLoadProgress = new TileLoadProgress(document.querySelector(`#progress`));
        //----SPINNER
        let spin = new Spinner(default_spinner);
        mainMap.map.on("loadstart",()=>{showMapLoading(); tileLoadProgress.show();})
        mainMap.map.on("loadend",()=>{hideMapLoading(); tileLoadProgress.hide();})
        //기본 지도 생성
        mainMap.setBaseLayer();


        mainMap.map.getLayers().getArray().filter(layer=>layer.get(`isBase`))
        .forEach(baseLayer=>{
            baseLayer.getSource().on(`tileloadstart`,function(){tileLoadProgress.addLoading()})
            baseLayer.getSource().on(`tileloadend`,function(){tileLoadProgress.addLoaded()})
        })
        


        //지도 위 이벤트들
         //배경지도 선택기 노출 버튼
        document.querySelector(`#baseLayerShifter_btn`).addEventListener(`click`,function(e){
            let options = document.querySelector(`#baseLayerShifter_option`);
            if(options.style.display ==='') options.style.display='block';
            else options.style.display ='';
        });
        //배경지도 선택기
        document.querySelectorAll(`.layerChanger`)
        .forEach(node => {
            const baseLayers= ['Base','midnight','gray','Satellite'];
            const hybridLayer= 'Hybrid';

                node.addEventListener(`click`, function (e) {
                    let layerName = node.dataset[`layer`];
                    //하이브리드 레이어 켜고 끄기
                    if(layerName===hybridLayer) {
                        let hyb = mainMap.map.getLayers().getArray().find(layer=>layer.get('typeName')==hybridLayer);
                        if(hyb) hyb.getVisible()? hyb.setVisible(false): hyb.setVisible(true);
                    }else{
                        //다른 레이어들은 바꾸기
                        mainMap.map.getLayers().getArray().filter(layer=>baseLayers.includes(layer.get('typeName')))
                        .forEach(layer => {
                            if (baseLayers.includes(layerName) && layer.get('typeName') === layerName) {
                                layer.setVisible(true);
                            } else layer.setVisible(false);
                        })
                    }
                });
        });
        
        //측정도구
        let measure = new Measure(mainMap.map, false);

        document.querySelectorAll(`input[name="control_measure"]`).forEach(node=>{
            node.addEventListener('change',function(e){
                if(e.target.checked){
                    measure.activeMeasure(e.target.value);
                }
            })
        })
        


        function showMapLoading(){spin.spin(document.querySelector(`#${default_spec.target}`));}
        function hideMapLoading(){spin.stop();}

        globalThis.mainMap_prepare = showMapLoading;
        globalThis.mainMap_done= hideMapLoading;
        globalThis.mainMap = mainMap;
        globalThis.mainMap_measure = measure;
    </script>
   
</head>

<body>
    <div class="wrapper">

        <div id="map"></div>
        <div id="progress"></div>
    </div>
<!-- 지도 우측 툴바 -->
    <div>
        <!-- 레이어 변경 -->
        <div class="mogis control flex container" id="baseLayerShifter">
            <button id="baseLayerShifter_btn" type="button" data-toggle="false">레이어 선택</button>
            <div id="baseLayerShifter_option">
                <div class="mogis flex options">
                    <div class="layerChanger" data-layer="Base">기본</div>
                    <div class="layerChanger" data-layer="Satellite">위성</div>
                    <div class="layerChanger" data-layer="midnight">야간</div>
                    <div class="layerChanger" data-layer="gray">백지도</div>
                    <div class="layerChanger" data-layer="Hybrid">하이브리드</div>
                </div>
            </div>
        </div>

        <!-- 길이, 면적 측정도구 (라디오버튼으로 구성할 것) -->
        <div class="mogis control flex container" id="measure">
            <!-- <button type="button" class="mogis measure option" data-value="">기본</button>
            <button type="button" class="mogis measure option" data-value="LineString">길이 length</button>
            <button type="button" class="mogis measure option" data-value="Polygon">면적 area</button> -->
            <div class="mogis measure option">
                <label for="pan">
                    <input type="radio" name="control_measure" id="pan" value="">
                    기본
                </label>
            </div>
            <div class="mogis measure option">
                <label for="measure_line">
                    <input type="radio" name="control_measure" id="measure_line" value="LineString">길이
                </label>
            </div>
            <div class="mogis measure option">
                <label for="poly">
                    <input type="radio" name="control_measure" id="poly" value="Polygon">면적 area                    
                </label>
            </div>
        </div>

    </div>
</body>

</html>